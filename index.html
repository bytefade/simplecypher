<!doctype html>
<html>
    <head>
        <title>Simple cypher</title>
    </head>
    <body>
        <h4>Cifrar texto</h4>
        <label>Texto original</label>
        <textarea id="text"></textarea>
        <button onclick="init_cifrar()">cifrar</button>
        <label>Texto cifrado</label>
        <textarea id="cifrada"></textarea>

        <h4>Decifrar texto</h4>
        <label>Texto cifrado</label>
        <textarea id="text_cifrado"></textarea>
        <button onclick="init_decifrar()">decifrar</button>
        <label>Texto original</label>
        <textarea id="decifrada"></textarea>
    </body>
    <script>
        function init_cifrar() {
            let text = document.getElementById("text").value.toUpperCase();
            let msgs = text.split(" ");

            let palavra_base = "";
            let cifrada = "";

            let contMsgs = 0;

            for (msg of msgs) {
                let len = msg.length;
                let k = gerarKValido(len);
                let sumIdx = sum(len);
                console.log(sumIdx);
                for (i = 0; i < len; i++) {
                    let i_letra = caracteres(i, msg[i]);

                    let retorno_cifrada = cifrar(i_letra, len, sumIdx, k);
                    // let caracter = caracteres(retorno_cifrada);
                    // let existe = cifrada.indexOf(caracter);

                    // if (existe !== -1) {
                    //     cifrada += caracteres(retorno_cifrada + 1);
                    // } else {
                    cifrada += caracteres(retorno_cifrada);
                    // }
                }
                if (msgs.length > 1 && contMsgs < msgs.length - 1) {
                    cifrada += "$";
                }
                contMsgs++;
            }
            let textAreaCifrada = document.getElementById("cifrada");
            textAreaCifrada.innerHTML = cifrada;
        }
        function init_decifrar() {
            let text = document
                .getElementById("text_cifrado")
                .value.toUpperCase();
            let msgs = text.split(" ");

            let palavra_base = "";
            let cifrada = "";

            let contMsgs = 0;

            for (msg of msgs) {
                let len = msg.length;
                let k = gerarKValido(len);
                let sumIdx = sum(len);
                console.log(sumIdx);

                for (i = 0; i < len; i++) {
                    let i_letra = caracteres(i, msg[i]);

                    let retorno_cifrada = decifrar(i_letra, len, sumIdx, k);
                    console.log("retorno_cifrada", retorno_cifrada);
                    // let caracter = caracteres(retorno_cifrada);
                    // let existe = cifrada.indexOf(caracter);

                    // if (existe !== -1) {
                    //     cifrada += caracteres(retorno_cifrada - 1);
                    // } else {
                    cifrada += caracteres(retorno_cifrada);
                    // }
                }
                if (msgs.length > 1 && contMsgs < msgs.length - 1) {
                    cifrada += "$";
                }
                contMsgs++;
            }
            let textAreaCifrada = document.getElementById("decifrada");
            textAreaCifrada.innerHTML = cifrada;
        }
        function sum(x) {
            let s = 0;
            for (i = 0; i <= x; i++) {
                s += i;
            }
            return s;
        }
        function cifrar(i, wl, sumIdx, k) {
            return (i * k + (sumIdx % wl)) % wl;
        }
        function decifrar(pos_cif, wl, sumIdx, k) {
            const kInv = inversoModular(k, wl);
            console.log(
                `pos_cif: ${pos_cif}, wl: ${wl}, k: ${k} kInv: ${kInv} sumidx: ${sumIdx}`,
            );
            return ((pos_cif - (sumIdx % wl) + wl) * kInv) % wl;
        }

        // Função para gerar um k válido (coprimo com WL)
        function gerarKValido(wl, tentativas = 100) {
            for (let k = 1; k < tentativas; k++) {
                if (mdc(k, wl) === 1) {
                    return k;
                }
            }
            return 1; //fallback seguro (1 é sempre coprimo)
        }

        // Função para calcular MDC (Máximo Divisor Comum)
        function mdc(a, b) {
            while (b !== 0) {
                let temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }
        function inversoModular(k, wl) {
            for (let x = 1; x < wl; x++) {
                if ((k * x) % wl === 1) {
                    return x;
                }
            }
            return 1; //fallback
        }

        function caracteres(index, simbolo = null) {
            let caracteres = [
                "A",
                "B",
                "C",
                "D",
                "E",
                "F",
                "G",
                "H",
                "I",
                "J",
                "K",
                "L",
                "M",
                "N",
                "O",
                "P",
                "Q",
                "R",
                "S",
                "T",
                "U",
                "V",
                "W",
                "X",
                "Y",
                "Z",
                "0",
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8",
                "9",
            ];

            if (simbolo) {
                return caracteres.indexOf(simbolo);
            }

            return caracteres[index];
        }
    </script>
</html>
